{"version":3,"sources":["webpack:///webpack/universalModuleDefinition","webpack:///webpack/bootstrap e968608d92c131a09105","webpack:///./src/logger.js","webpack:///./src/index.js","webpack:///external \"@google-cloud/logging\"","webpack:///external \"pmx\"","webpack:///./src/ncryp.js","webpack:///external \"blind\"","webpack:///./src/handlerResponse.js","webpack:///./src/auth/index.js","webpack:///./src/redis.js","webpack:///external \"redis\"","webpack:///external \"jsonwebtoken\"","webpack:///./src/calculations.js","webpack:///./src/math.js","webpack:///external \"mathjs\"","webpack:///./src/stripe.js","webpack:///external \"stripe\"","webpack:///./src/sequence.js","webpack:///external \"aws-sdk\"","webpack:///external \"async-lock\""],"names":["metadata","log","localLog","type","msg","plainMsg","JSON","stringify","console","info","debug","warn","error","write","notify","process","env","NODE_ENV","entry","err","apiResponse","Logger","config","logging","projectId","logName","Ncryp","HandlerResponse","auth","Calculations","Stripe","Sequence","encryptKey","key","value","encrypted","encrypt","encryptedValue","decrypted","decrypt","response","status","json","code","resason","serverTokenAuthenticated","req","token","headers","authorization","split","query","hasOwnProperty","body","Auth","res","next","secret","Error","sendStatus","decoded","decode","redis","del","user","email","apiKey","verify","message","get","then","catch","reason","rembemberMe","expireTime","sign","expiresIn","set","toLowerCase","port","host","credential","instance","Redis","client","createClient","on","expiration","Promise","resolve","reject","reply","expire","product","due","cardFee","processingFees","cardFeeFlat","paidUpFee","collectionFees","fee","paidUpFeeFlat","feeFlat","price","amount","processing","payFees","collect","result","paidupFee","priceBase","round","achFeeCap","achFee","achFeeFlat","Math","num","sk","stripe","payload","accounts","create","account","lock","lambda","options","params","region","apiVersion","Lambda","qty","opt","FunctionName","functionName","InvocationType","LogType","Payload","db","acquire","done","invoke","data","parse","ret"],"mappings":"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","file":"library.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"pu-common\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"pu-common\"] = factory();\n\telse\n\t\troot[\"pu-common\"] = factory();\n})(typeof self !== 'undefined' ? self : this, function() {\nreturn \n\n\n// WEBPACK FOOTER //\n// webpack/universalModuleDefinition"," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/lib/\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 1);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap e968608d92c131a09105","import Logging from '@google-cloud/logging'\nimport pmx from 'pmx'\n\nlet { metadata, log } = {}\n\nfunction localLog (type, msg) {\n  const plainMsg = JSON.stringify(msg)\n  if (type === 'info') {\n    console.info(plainMsg)\n  } else if (type === 'debug') {\n    console.debug(plainMsg)\n  } else if (type === 'warning') {\n    console.warn(plainMsg)\n  } else {\n    console.error(plainMsg)\n  }\n}\n\nfunction write (type, msg, notify) {\n  if (process.env.NODE_ENV === 'test') {\n    return\n  }\n  const entry = log.entry(metadata, msg)\n  if (notify) {\n    pmx.notify(msg)\n  }\n  log[type](entry, (err, apiResponse) => {\n    if (err) {\n      console.error('Error: ', err)\n      console.error(`${type}: `, JSON.stringify(msg))\n    }\n  })\n  if (process.env.NODE_ENV === 'local') {\n    localLog(type, msg)\n  }\n}\n\nexport default class Logger {\n  static setConfig (config) {\n    metadata = config.metadata\n    if (process.env.NODE_ENV !== 'test') {\n      const logging = new Logging({\n        projectId: config.projectId\n      })\n      log = logging.log(config.logName)\n    }\n  }\n\n  static info (msg) {\n    write('info', msg)\n  }\n\n  static critical (msg) {\n    write('critical', msg, true)\n  }\n\n  static debug (msg) {\n    write('debug', msg)\n  }\n\n  static emergency (msg) {\n    write('emergency', msg, true)\n  }\n\n  static error (msg) {\n    write('error', msg, true)\n  }\n\n  static notice (msg) {\n    write('notice', msg)\n  }\n\n  static warning (msg) {\n    write('warning', msg)\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/logger.js","import Logger from './logger'\nimport Ncryp from './ncryp'\nimport HandlerResponse from './handlerResponse'\nimport auth from './auth'\nimport Calculations from './calculations'\nimport Stripe from './stripe'\nimport Sequence from './sequence'\n\nexport {\n  Logger,\n  Ncryp,\n  HandlerResponse,\n  auth,\n  Calculations,\n  Stripe,\n  Sequence\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"@google-cloud/logging\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"@google-cloud/logging\"\n// module id = 2\n// module chunks = 0","module.exports = require(\"pmx\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"pmx\"\n// module id = 3\n// module chunks = 0","import Blind from 'blind'\n\nlet encryptKey\n\nexport default class Ncryp {\n  static setKey (key) {\n    encryptKey = key\n  }\n\n  static encryptField (value) {\n    let encrypted = new Blind({ encryptKey }).encrypt(value)\n    return encrypted\n  }\n\n  static decryptField (encryptedValue) {\n    var decrypted = new Blind({ encryptKey }).decrypt(encryptedValue)\n    return decrypted\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/ncryp.js","module.exports = require(\"blind\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"blind\"\n// module id = 5\n// module chunks = 0","import Logger from './logger'\n\nexport default class HandlerResponse {\n  static send (response, msg) {\n    return response.status(200).json(msg)\n  }\n\n  static error (response, msg, code) {\n    Logger.error({code: code, resason: msg})\n    return response.status(code || 500).json(msg)\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/handlerResponse.js","// import config from '@/config/environment'\nimport Redis from '../redis'\nimport jwt from 'jsonwebtoken'\n\n/**\n * Attaches the user object to the request if authenticated\n * Otherwise returns 403\n */\n\nfunction serverTokenAuthenticated (req) {\n  let token\n  // allow access_token to be passed through query parameter as well\n  if (req.headers.authorization) {\n    token = req.headers.authorization.split(' ')[1]\n  } else if (req.query && req.query.hasOwnProperty('token')) {\n    token = req.query.token\n  } else if (req.body && req.body.token) {\n    token = req.body.token\n  } else if (req.query && req.query.hasOwnProperty('access_token')) {\n    token = req.query.token\n  }\n  return token\n}\n\nlet auth\n\nclass Auth {\n  set config ({ port, host, credential, apiKey }) {\n    this.secret = credential\n    this.redis = new Redis(port, host)\n    this.apiKey = apiKey\n  }\n\n  static get instance () {\n    if (!auth) {\n      auth = new Auth()\n    }\n    return auth\n  }\n\n  revoke (req, res, next) {\n    if (!this.secret) {\n      throw new Error('first must set cretendials, use fn setCredential')\n    }\n    let token = serverTokenAuthenticated(req)\n    if (!token) {\n      return res.sendStatus(401)\n    }\n    const decoded = jwt.decode(token)\n    if (decoded) {\n      this.redis.del(decoded.user.email)\n    }\n    next()\n  }\n\n  validate (req, res, next) {\n    if (!this.secret) {\n      throw new Error('first must set cretendials, use fn config')\n    }\n    if (!this.apiKey) {\n      throw new Error('first must set cretendials, use fn config')\n    }\n    if (req.headers['x-api-key']) {\n      if (req.headers['x-api-key'] === this.apiKey) {\n        return next()\n      }\n      return res.sendStatus(401)\n    }\n    let token = serverTokenAuthenticated(req)\n    if (!token) {\n      return res.sendStatus(401)\n    }\n    jwt.verify(token, this.secret, (error, decoded) => {\n      if (error) {\n        return res.status(500).json({error, message: 'invalid token'})\n      }\n      this.redis.get(decoded.user.email).then(value => {\n        if (token !== value) return res.sendStatus(401)\n        req.user = decoded.user\n        next()\n      }).catch(reason => {\n        res.sendStatus(500).json(reason)\n      })\n    })\n  }\n\n  token (user, rembemberMe) {\n    let expireTime = (60 * 60)\n    if (rembemberMe) {\n      expireTime = expireTime * 60\n    }\n    let token = jwt.sign({ user }, this.secret, {\n      expiresIn: expireTime\n    })\n    this.redis.set(user.email.toLowerCase(), token, expireTime)\n    return token\n  }\n\n  remove (email) {\n    return this.redis.del()\n  }\n}\n\nexport default auth = Auth.instance\n\n\n\n// WEBPACK FOOTER //\n// ./src/auth/index.js","import redis from 'redis'\n\nexport default class Redis {\n  constructor (port, host) {\n    this.client = redis.createClient(port, host)\n    this.client.on('connect', function () {\n    })\n  }\n\n  set (key, value, expiration = 86400) {\n    return new Promise((resolve, reject) => {\n      this.client.set(key, value, (err, reply) => {\n        if (err) {\n          reject(err)\n        }\n        this.client.expire(key, expiration)\n        resolve(reply)\n      })\n    })\n  }\n\n  get (key) {\n    return new Promise((resolve, reject) => {\n      this.client.get(key, (err, reply) => {\n        if (err) {\n          reject(err)\n        }\n        resolve(reply)\n      })\n    })\n  }\n\n  del (key) {\n    return new Promise((resolve, reject) => {\n      this.client.del(key, (err, reply) => {\n        if (err) {\n          reject(err)\n        }\n        resolve(reply)\n      })\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/redis.js","module.exports = require(\"redis\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"redis\"\n// module id = 9\n// module chunks = 0","module.exports = require(\"jsonwebtoken\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"jsonwebtoken\"\n// module id = 10\n// module chunks = 0","import Math from './math'\n\nexport default class Calculations {\n  static card (product, due) {\n    const cardFee = product.processingFees.cardFee / 100\n    const cardFeeFlat = product.processingFees.cardFeeFlat\n    const paidUpFee = product.collectionFees.fee / 100\n    const paidUpFeeFlat = product.collectionFees.feeFlat\n    const price = due.amount\n    const processing = product.payFees.processing\n    const collect = product.payFees.collect\n\n    var result = {\n      paidupFee: 0,\n      priceBase: 0\n    }\n\n    if (!processing && collect) {\n      result.priceBase = Math.round((price - paidUpFeeFlat) / (1 + paidUpFee))\n    } else if (!processing && !collect) {\n      result.priceBase = Math.round(price)\n    } else if (processing && collect) {\n      result.priceBase = Math.round((price - price * cardFee - paidUpFeeFlat - cardFeeFlat) / (1 + paidUpFee))\n    } else if (processing && !collect) {\n      result.priceBase = Math.round(price - price * cardFee - cardFeeFlat)\n    }\n\n    result.paidupFee = Math.round(result.priceBase * paidUpFee + paidUpFeeFlat)\n\n    return result\n  }\n\n  static bank (product, due) {\n    const achFeeCap = product.processingFees.achFeeCap\n    const achFee = (product.processingFees.achFee / 100)\n    const achFeeFlat = product.processingFees.achFeeFlat\n    const paidUpFee = product.collectionFees.fee / 100\n    const paidUpFeeFlat = product.collectionFees.feeFlat\n    const price = due.amount\n    const collect = product.payFees.collect\n    const processing = product.payFees.processing\n\n    var result = {\n      priceBase: 0,\n      paidupFee: 0\n    }\n\n    if (!processing && collect) {\n      result.priceBase = Math.round((price - paidUpFeeFlat) / (1 + paidUpFee))\n    } else if (!processing && !collect) {\n      result.priceBase = Math.round(price)\n    } else if (processing && collect) {\n      if (price <= (achFeeCap / achFee)) {\n        result.priceBase = Math.round((price - price * achFee - paidUpFeeFlat - achFeeFlat) / (1 + paidUpFee))\n      } else {\n        result.priceBase = Math.round((price - achFeeCap - paidUpFeeFlat) / (1 + paidUpFee))\n      }\n    } else if (processing && !collect) {\n      if (price <= (achFeeCap / achFee)) {\n        result.priceBase = Math.round(price - price * achFee - achFeeFlat)\n      } else {\n        result.priceBase = Math.round(price - achFeeCap - achFeeFlat)\n      }\n    }\n\n    result.paidupFee = Math.round(result.priceBase * paidUpFee + paidUpFeeFlat)\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/calculations.js","import mathjs from 'mathjs'\n\nexport default class Math {\n  static round (num) {\n    return mathjs.round(num, 2)\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/math.js","module.exports = require(\"mathjs\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"mathjs\"\n// module id = 13\n// module chunks = 0","import str from 'stripe'\n\nexport default class Stripe {\n  constructor (sk) {\n    this.stripe = str(sk)\n  }\n\n  createConnectAccount (payload) {\n    return new Promise((resolve, reject) => {\n      this.stripe.accounts.create(payload, (err, account) => {\n        if (err) return reject(err)\n        resolve(account)\n      })\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/stripe.js","module.exports = require(\"stripe\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"stripe\"\n// module id = 15\n// module chunks = 0","import AWS from 'aws-sdk'\nimport AsyncLock from 'async-lock'\nconst lock = new AsyncLock()\nlet lambda\nlet options\n\nexport default class Sequence {\n  static setConfig (params, region = 'us-east-1', apiVersion = '2015-03-31') {\n    options = params\n    lambda = new AWS.Lambda({region, apiVersion})\n  }\n\n  static next (key, qty = 1) {\n    let opt = {\n      FunctionName: options.functionName,\n      InvocationType: 'RequestResponse',\n      LogType: 'None',\n      Payload: JSON.stringify({\n        key,\n        db: options.db,\n        host: options.host,\n        port: options.port,\n        qty\n      })\n    }\n    return new Promise((resolve, reject) => {\n      lock.acquire(key, function (done) {\n        lambda.invoke(opt, function (error, data) {\n          if (error) return done(error)\n          done(null, JSON.parse(data.Payload))\n        })\n      }, function (err, ret) {\n        if (err) {\n          reject(err)\n        } else {\n          resolve(ret)\n        }\n      })\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/sequence.js","module.exports = require(\"aws-sdk\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"aws-sdk\"\n// module id = 17\n// module chunks = 0","module.exports = require(\"async-lock\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"async-lock\"\n// module id = 18\n// module chunks = 0"],"sourceRoot":""}